name: Secure RDP Setup

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: üõ†Ô∏è Setup RDP and Tailscale
        shell: pwsh
        run: |
          Write-Host "üöÄ Starting RDP configuration..."

          # === Step 1: Configure Password ===
          $username = "runneradmin"
          $password = "${{ secrets.RDP_PASSWORD }}"

          if ([string]::IsNullOrWhiteSpace($password)) {
              throw "‚ùå Missing RDP_PASSWORD secret. Please set it in GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions."
          }

          try {
              Write-Host "üîê Setting password for user: $username"
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              Set-LocalUser -Name $username -Password $securePass
              Write-Host "‚úÖ Password successfully set for $username"
          }
          catch {
              Write-Host "‚ö†Ô∏è Failed to set password: $($_.Exception.Message)"
              exit 1
          }

          # === Step 2: Enable Remote Desktop ===
          Write-Host "üñ•Ô∏è Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # === Step 3: Install and Configure Tailscale ===
          Write-Host "üåê Installing Tailscale..."
          choco install tailscale -y | Out-Null

          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          if ([string]::IsNullOrWhiteSpace($authKey)) {
              throw "‚ùå Missing TAILSCALE_AUTH_KEY secret. Please set it in GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions."
          }

          Write-Host "üîë Logging in to Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout | Out-Null
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname="GitHubRDP" --accept-routes

          # === Step 4: Verify Connection ===
          Write-Host "üîé Checking Tailscale IP..."
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4) 2>$null

          if (-not $tsIP) {
              Write-Host "‚ùå Failed to get Tailscale IP. Check your AUTH KEY validity."
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }

          Write-Host "‚úÖ Tailscale Connected! IP Address: $tsIP"

          # === Step 5: Display Login Info ===
          Write-Host ""
          Write-Host "=============================="
          Write-Host "‚úÖ RDP Setup Complete!"
          Write-Host "Username: $username"
          Write-Host "Password: $password "
          Write-Host "Tailscale IP: $tsIP"
          Write-Host "=============================="
          Write-Host ""
          Write-Host "üí° Connect using:"
          Write-Host "    Remote Desktop ‚Üí $tsIP"
          Write-Host ""
